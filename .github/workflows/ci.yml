name: CI

# Controls when the action will run. Triggers the workflow on push or pull
# request events but only for the main branch.
on:
  push:
    # Run on the main branch and ci/* branches for testing.
    branches:
      - main
      - "ci/**"
    tags:
      - "v*"
  pull_request:
    # Only run on pull requests against main.
    branches: [main]

jobs:
  # We run this job first, to create any GitHub release that we might need.
  # Creating a release can only be done once, so we need to split it out from
  # other jobs.
  create_release:
    name: Create release (if needed)
    runs-on: ubuntu-latest
    outputs:
      release_version: ${{ steps.extract_release_version.outputs.release_version }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4
      - name: Extract release version
        id: extract_release_version
        run: |
          release_version="$(echo '${{ github.ref }}' | sed 's,^.*/\([^/]*\)$,\1,; s,^v,,' )"
          echo "Release version: $release_version"
          echo "release_version=$release_version" >> "$GITHUB_OUTPUT"
      - name: Extract release body from CHANGELOG.md
        id: extract_release_body
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        # Use `clparse` to parse `CHANGELOG.md` and extract release notes.
        run: |
          curl -sLO https://github.com/marcaddeo/clparse/releases/download/0.8.0/clparse-0.8.0-x86_64-unknown-linux-musl.tar.gz
          tar xzf clparse*.tar.gz
          sudo cp clparse /usr/local/bin
          rm -rf clparse*
          clparse -f json CHANGELOG.md | \
            jq ".releases[] | select(.version == \"${{ steps.extract_release_version.outputs.release_version }}\") | { title: \"\", description: \"\", releases: [.] }" | \
            clparse - | \
            tail -n +3 > RELEASE_BODY.md
      - name: "Make release"
        id: create_release
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: "${{ steps.extract_release_version.outputs.release_version }}"
          body_path: RELEASE_BODY.md

  # We use a matrix to run our build on every supported platform.
  build:
    name: "Build"

    needs:
      - create_release

    strategy:
      matrix:
        # target: Official name of system to compile for.
        # os: GitHub CI OS image to use on runner.
        include:
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
          - target: aarch64-apple-darwin
            os: macos-14

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
          targets: ${{ matrix.target }}

      - name: Install musl-tools
        if: contains(matrix.target, 'musl')
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Check source formatting
        run: cargo fmt -- --check

      - name: Run cargo deny
        run: cargo deny check

      - name: Run clippy
        run: cargo clippy -- -D warnings

      - name: Run tests
        run: cargo test --all

      - name: Build release binaries
        run: cargo build --release --target ${{ matrix.target }}

      - name: Upload binaries as artifact
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.target }}
          path: |
            target/${{ matrix.target }}/release/falconeri
            target/${{ matrix.target }}/release/falconerid
            target/${{ matrix.target }}/release/falconeri-worker
          if-no-files-found: error

      - name: Package release
        id: build_release
        run: |
          # Create zip with CLI binary (falconeri) for release download
          release_file=falconeri_${{ needs.create_release.outputs.release_version }}_${{ matrix.target }}.zip
          zip -j "$release_file" target/${{ matrix.target }}/release/falconeri
          echo "release_file=$release_file" >> "$GITHUB_OUTPUT"

      - name: Upload Release Asset
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create_release.outputs.upload_url }}
          asset_path: ./${{ steps.build_release.outputs.release_file }}
          asset_name: ${{ steps.build_release.outputs.release_file }}
          asset_content_type: application/zip

  # Build and publish Docker image
  docker:
    name: "Docker Image"
    needs: [create_release, build]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-x86_64-unknown-linux-musl
          path: target/x86_64-unknown-linux-musl/release/

      - name: Make binaries executable
        run: chmod +x target/x86_64-unknown-linux-musl/release/*

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        run: |
          docker build \
            --build-arg MODE=release \
            --build-arg MUSL_TARGET=x86_64-unknown-linux-musl \
            -t ghcr.io/${{ github.repository_owner }}/falconeri:${{ needs.create_release.outputs.release_version }} .

      - name: Push Docker image
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        run: docker push ghcr.io/${{ github.repository_owner }}/falconeri:${{ needs.create_release.outputs.release_version }}
